!function(){"use strict";function e(e,t){return t._id-e._id}function t(e,t){var n=$.map(e,function(e,n){return e._id==t?n:void 0});return n[0]}angular.module("electricityUsageApp",["ui.router","infinite-scroll","hmTouchEvents","flash","ngAnimate","ngCookies","ngMessages"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/"),e.state("summary",{url:"/summary",templateUrl:"partials/summary.html",controller:"SummaryController",controllerAs:"summary"}).state("home",{url:"/",templateUrl:"partials/data.html",controller:"DataController",controllerAs:"data"}).state("settings",{url:"/settings",templateUrl:"partials/settings.html",controller:"MainController"})}]).run(["$rootScope","$state","$stateParams","$cookies","data",function(e,t,n,i,a){function r(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var s=i.get("guid");s||i.put("guid",r()),e.$state=t,e.$stateParams=n,e.$on("$stateChangeSuccess",function(t,n,i,a,r){e.$state.previous=a})}]).factory("Scopes",["$rootScope","$cookies",function(e,t){function n(e){return e+"-"+t.get("guid")}var i={};return{store:function(t,a){t=n(t),e.$emit("scope.stored",{key:t,value:a}),i[t]=a},get:function(e){return e=n(e),i[e]},remove:function(e){e=n(e),delete i[e]}}}]).filter("humanizeDuration",["$sce",function(e){return function(t){if(t=1e3*parseInt(t/1e3)){t=humanizeDuration(t,{largest:2,delimiter:","});var n=t.split(","),i=[];return angular.forEach(n,function(e){i.push('<span class="no-wrap">'+e+"</span>")}),e.trustAsHtml(i.join(" and "))}return null}}]).filter("dateFilter",function(){return function(e,t,n){if(!t&&!n)return e;var i=new Date(t)||new Date,a=new Date(n)||new Date,r=[];i=moment(i.getTime()).toDate().valueOf(),a=moment(a.getTime()).add(1,"days").toDate().valueOf();for(var s=0;s<e.length;s++){var o=parseInt(e[s]._id);o>=i?(!a||a&&a>=o)&&r.push(e[s]):a>=o&&(!i||i&&o>=i)&&r.push(e[s])}return r}}).filter("rangeFilter",function(){return function(e,t){if(!t)return e;var n=[],i=parseFloat(t.min||0),a=parseFloat(t.max)||(e.length?Math.max.apply(null,_.pluck(e,"reading")):!1);return angular.forEach(e,function(e){e.reading>=i&&(!a||e.reading<=a)&&n.push(e)}),n}}).filter("reverse",function(){return function(e){return e?e.slice().reverse():void 0}}).service("db",function(){var e="electricity-usage",t=new PouchDB(e,{auto_compaction:!0});return t}).factory("util",["$q","$rootScope",function(e,t){return{resolve:function(n){t.$apply(function(){return e.when(n)})},reject:function(n){t.$apply(function(){return e.reject(n)})}}}]).factory("data",["$rootScope","$cookies","db","util","dataService","Scopes",function(n,i,a,r,s,o){function c(){if($.isEmptyObject(h))return!1;var e,t="http://{0}:5984/{1}";e=String.format(t,h.server,h.database);var n={name:h.username,password:h.password},i={skipSetup:!0},a={ajax:{headers:{Authorization:"Basic "+window.btoa(n.name+":"+n.password)}}},r=new PouchDB(e,i);r.login(n.name,n.password,a,function(e,t){if(e){var n;switch(e.status){case 401:n=e.message;break;default:n=" Cannot connect to specified server or database. Please check your settings and try again."}return(h.enableSync||h.server&&h.database)&&o.store("flashMessage",{severity:"danger",title:String.format("Error {0}!",e.status),message:String.format("{0}<br>{1}",n,e.message)}),o.store("dbStatus",{dbConnection:!1}),!1}}).then(function(e){if(e){var t=[];angular.forEach(e.roles,function(e){return t.push(e.substring(1))}),o.store("userRoles",t)}h.enableSync?u():(o.store("flashMessage",{severity:"info",title:"Info: ",message:"You can now sync your data to the server."}),o.store("dbStatus",{dbConnection:!0}))})["catch"](function(e){})}function u(){console.log("sync");var e="http://{0}:{1}@{2}:5984/{3}",t=String.format(e,h.username,h.password,h.server,h.database);n.$apply(function(){p=a.sync(t,{live:!0,filter:function(e){return"reading"===e.type||e._deleted}}).on("paused",function(){v=!0,o.store("dbStatus",{dbConnection:v}),o.store("flashMessage",{title:"Success!",message:"Database sync successful.",severity:"success"}),console.log("paused")}).on("active",function(){console.log("active"),o.store("flashMessage",{title:"",message:"Syncing...",severity:"info"})}).on("denied",function(e){console.log("denied",e)}).on("complete",function(e){console.log(e)}).on("error",function(e){v=!1,o.store("dbStatus",{dbConnection:v}),console.log("error!",e)})})}function l(){return a.allDocs({include_docs:!0,descending:!0}).then(function(t){var a=t.rows.map(function(e){return e.doc});angular.forEach(a,function(e,t){switch(e.type){case"reading":m.push(e);break;case"settings":e._id=="settings-"+i.get("guid")&&($.extend(h,e),o.store("settings",h))}}),m.sort(e),n.$apply(),c()})}function d(){a.changes({live:!0,since:"now",include_docs:!0}).on("change",function(e){e.deleted?f(e.id):g(e.doc)}).on("error",console.log.bind(console))}function f(e){switch(e){case"settings-"+i.get("guid"):n.$apply(function(){h={}}),o.store("settings",h);break;default:var a=t(m,e),r=m[a];r&&r._id===e&&n.$apply(function(){m.splice(a,1)})}}function g(a){switch(a.type){case"reading":var r=t(m,a._id),s=m[r];n.$apply(function(){s&&s._id===a._id?m.splice(r,1,a):(m.splice(r,0,a),m.sort(e))});break;case"settings":"settings-"+i.get("guid")==a._id&&(n.$apply(function(){$.extend(h,a)}),o.store("settings",h),c());break;default:console.log(a.reading)}}var p,m=[],h={},v=!1;return l().then(d)["catch"](console.log.bind(console)),{dbConnection:v,docs:m,settings:h,syncDB:c,put:function(e,t){return a.put(e,function(n){if(t)if(n){var i;switch(n.name){case"conflict":i="reading"==e.type?String.format('An entry with same date and time <span class="no-wrap"><b>({0})</b></span> already exists.',moment(parseInt(e._id)).format("MMM D, YYYY h:mm A")):"Entry already exists.";break;default:i="Entry already exists."}o.store("flashMessage",{title:"Error!",message:i,severity:"danger",pause:!0})}else{var a=o.get("dbStatus");if(void 0===a||!a.dbConnection){var r="";switch(e.type){case"settings":r="Settings saved successfully!";break;default:r="Entry saved successfully!"}o.store("flashMessage",{title:"Success!",message:r,severity:"success"})}}}).then(r.resolve)["catch"](r.reject)},get:function(e){return a.get(e).then(function(e){return e})["catch"](r.reject)},"delete":function(e,t){return a.get(e._id).then(function(e){return a.remove(e).then(function(){if(t){var n="";switch(e.type){case"reading":n=String.format("Entry with reading of <b>{0}</b> dated <no-wrap><b>{1}</b></no-wrap> <no-wrap><b>{2}</b></no-wrap> was deleted successfully!",e.reading,moment(parseInt(e._id)).format("MMM D, YYYY"),moment(parseInt(e._id)).format("h:mm A"));break;default:n="Entry was deleted successfully!"}o.store("flashMessage",{title:"Success!",message:n,severity:"success"})}r.resolve()},r.reject)})["catch"](r.reject)}}}]).service("flashMessage",["Flash",function(e){return{create:function(t){e.dismiss(),e.create(t.severity,"<strong>"+t.title+"</strong>&nbsp;&nbsp;"+t.message,t["class"])},pause:function(){e.pause()}}}]).service("dataService",["Scopes","$cookies",function(e,t){function n(){i=e.get("settings"),a=i?i.electricityRate:13,a=a||13}var i,a;return{calculate:function(e){return n(),angular.forEach(e,function(t,n){var i=e[n+1];i?(t.duration=t._id-i._id,t.usage=t.reading-i.reading,t.cost=t.usage*a,t.aveUsagePerHour=t.usage/(t.duration/36e5),t.aveCostPerHour=t.aveUsagePerHour*a):(t.elapsedTime="-",t.usage="-",t.cost="-",t.aveUsagePerHour="-",t.aveCostPerHour="-")}),e},getSummary:function(e,t){var i={};n(),i.startDateTime=e._id,i.endDateTime=t._id,i.startReading=e.reading,i.latestReading=t.reading,i.electricityRate=a,i.currentUsage=t.reading-e.reading,i.elapsedTime=parseInt(t._id)-parseInt(e._id),i.currentCost=i.currentUsage*i.electricityRate;var r=i.elapsedTime/864e5;return i.aveUsagePerDay=r>=1?i.currentUsage/r:i.currentUsage,i.aveCostPerDay=r>=1?i.currentCost/r:i.currentCost,i}}}]).controller("MainController",["$scope","$cookies","db","data","Scopes","flashMessage",function(e,t,n,i,a,r){function s(){e.settings.enableSync=!e.settings.enableSync,i.put(e.settings).then(function(t){i.get(l._id).then(function(t){e.$apply(function(){$.extend(i.settings,t),e.settings=i.settings}),e.settings.enableSync?a.store("flashMessage",{title:"",message:"Database sync started.",severity:"info"}):a.store("flashMessage",{title:"",message:"Stopping database sync...",severity:"info"})})},function(e){console.log(e)})}var o=3500;e.appName="reading-trackr",e.title=e.appName+" App",e.flashDuration=o,e.serverPlaceholder=window.location.hostname,e.defaultElectricityRate="Default: P 13.00";var c=(new Date).getFullYear(),u=2015!=c?"2015 - "+c:2015;e.footerText=String.format("Â© {0} Electricity Reading Trackr App | uNkNowN92",u),e.settings=i.settings,e.syncDB=function(){s()},e.$on("scope.stored",function(n,i){e.$apply(function(){switch(i.key){case"dbStatus-"+t.get("guid"):e.dbConnection=i.value.dbConnection,!e.dbConnection&&e.settings.enableSync&&s();break;case"flashMessage-"+t.get("guid"):r.create({severity:i.value.severity,title:i.value.title,message:i.value.message}),i.value.pause&&r.pause()}})});var l={_id:"settings-"+t.get("guid"),type:"settings"};e.saveSettings=function(){var t=l;$.extend(t,e.settings),i.put(t).then(function(t){i.get(l._id).then(function(t){e.$apply(function(){$.extend(i.settings,t),e.settings=i.settings}),a.store("flashMessage",{title:"Success!",message:"Settings saved successfully!",severity:"success"})})},function(e){console.log(e)})},e.resetSettings=function(){i.get(l._id).then(function(t){t.server=null,t.database=null,t.username=null,t.password=null,t.electricityRate=null,i.put(t).then(function(){e.$apply(function(){e.settings=i.settings,e.settingsForm.$setPristine()}),a.store("flashMessage",{title:"Success!",message:"Settings cleared successfully!",severity:"success"})})})["catch"](function(e){console.log(e)})}}]).controller("DataController",["$scope","data","dataService","Scopes","$filter",function(e,n,i,a,r){function s(t){e.editedReading[t]=null,e.editedDateTime[t]=null,delete e.editingId,o(),e.$apply()}function o(){$(".xdsoft_datetimepicker").fadeOut()}function c(e){return e=parseInt(e),e=r("date")(e,"mediumDate")+" "+r("date")(e,"shortTime"),new Date(e).getTime().toString()}e.todos=n.docs,e.focusReading=[],e.focusDateTime=[],e.editedReading=[],e.editedDateTime=[],e.editedStartOfMonth=[],e.limit=10,e.loadMore=function(){e.limit<e.todos.length&&(e.limit+=10)},e.beginEditing=function(n,i){var a=t(e.todos,n),s=e.todos[a];e.index=a,e.focusReading[a]="reading"==i,e.focusDateTime[a]="dateTime"==i,e.editingId=n,e.editedReading[a]=parseFloat(s.reading).toFixed(1),e.editedDateTime[a]=r("date")(s._id,"mediumDate")+" "+r("date")(s._id,"shortTime"),e.editedStartOfMonth[a]=s.startOfMonth?!0:"",$.datetimepicker.setLocale("en"),$("#"+n).datetimepicker({format:"M j, Y h:i A",step:15,value:new Date(parseInt(s._id))})},e.editReading=function(t){var i=e.index,a={_id:new Date(e.editedDateTime[i]).getTime().toString(),reading:parseFloat(e.editedReading[i]),startOfMonth:e.editedStartOfMonth[i]===!0};a._id=c(a._id),n.get(t).then(function(t){if(a._id!=t._id){n["delete"](t)["catch"](function(e){console.log(e)});var r={type:"reading"};$.extend(r,a),n.put(r).then(function(e){s(i)},function(e){console.log(e)})}else if(a.reading!=t.reading)$.extend(t,a),n.put(t).then(function(e){s(i)},function(e){console.log(e)});else if(a.startOfMonth!=t.startOfMonth){var o=e.todos.sameMonth(a._id),c=o.startOfMonth();angular.forEach(c,function(e){e.startOfMonth=!1,n.put(e,!1).then(function(e){},function(e){console.log(e)})}),$.extend(t,a),n.put(t).then(function(e){s(i)},function(e){console.log(e)})}else s(i)})},e.closeDateTimePicker=function(){o()},e.addNewDoc=function(){var t={type:"reading",_id:c(e.dateTime||(new Date).getTime().toString()),reading:parseFloat(e.newReading).toFixed(1),startOfMonth:e.startOfMonth||!1};n.put(t).then(function(t){e.$apply(function(){e.newReading=""})},function(e){console.log(e)})},e.deleteDoc=function(e){confirm("Are you sure you want to delete this entry?")&&n["delete"](e,!0)["catch"](function(e){console.log(e)})},e.windowWidth=window.innerWidth,$(window).resize(function(){e.$apply(function(){e.windowWidth=window.innerWidth})})}]).controller("SummaryController",["$scope","data","Scopes","dataService","$filter",function(e,t,n,i,a){e.docs=t.docs,e.limit=10,e.resetLimit=function(){e.limit=10},e.loadMore=function(t,n){n?e.limit=n:(e.limit<e.docs.length&&e.windowWidth>800||t)&&(e.limit+=10)},e.downloadResultJson=function(){},e.getSummary=function(){var t,n,a;if(e.dateFrom||e.dateTo){if($.isEmptyObject(e.filteredDates))return;n=e.filteredDates[0],t=e.dateTo?e.filteredDates[e.filteredDates.length-1]:e.docs[0],a=i.getSummary(n,t)}else{if($.isEmptyObject(e.docs))return;n=e.docs[e.docs.length-1],t=e.docs[0],a=i.getSummary(n,t)}$.extend(e,a),e.docs=i.calculate(e.docs)},e.windowWidth=window.innerWidth,$(window).resize(function(){e.$apply(function(){e.windowWidth=window.innerWidth})})}]).directive("datetimePicker",["$timeout",function(e){return{restrict:"A",link:function(e,t,n){var i={value:new Date},a={};switch(n.datetimePicker){case"date":a.timepicker=!1,a.datepicker=!0,a.format="M j, Y";break;case"time":a.timepicker=!0,a.datepicker=!1,a.format="h:i A",a.step=15;break;default:a.format="M j, Y h:i A",a.step=15}$.extend(i,a),$('[datetime-picker="'+n.datetimePicker+'"]').datetimepicker(i)}}}]).directive("navbar",function(){return{restrict:"E",templateUrl:"partials/navbar.html",controller:"MainController"}}).directive("copyright",function(){return{restrict:"E",templateUrl:"partials/copyright.html",controller:"MainController"}}).directive("notification",["$timeout",function(e){return{restrict:"E",template:"<div class='alert alert-{{alertData.type}}' ng-show='alertData.message' role='alert' data-notification='{{alertData.status}}'>{{alertData.message}}</div>",scope:{alertData:"="}}}]).directive("validateFloat",function(){var e=/^\-?\d+((\.|\,)\d{0,1})?$/;return{require:"ngModel",link:function(t,n,i,a){a.$parsers.unshift(function(t){return""===t?(a.$setValidity("float",!0),t):e.test(t)?(a.$setValidity("float",!0),parseFloat(t.replace(",","."))):void a.$setValidity("float",!1)})}}}).directive("autoFocus",["$timeout",function(e){return{restrict:"AC",link:function(t,n){e(function(){n[0].focus()},0)}}}]).directive("focus",["$timeout",function(e){return{scope:{trigger:"=focus"},link:function(t,n){t.$watch("trigger",function(t){t===!0&&e(function(){n[0].focus()},250)})}}}]).directive("onShow",function(){});String.format=function(){for(var e=arguments[0],t=0;t<arguments.length-1;t++){var n=new RegExp("\\{"+t+"\\}","gm");e=e.replace(n,arguments[t+1])}return e},Array.prototype.startOfMonth=function(){return _.map(_.where(this,{startOfMonth:!0}))},Array.prototype.sameMonth=function(e){var t=moment(parseInt(e)).get("month"),n=moment(parseInt(e)).get("year"),i=moment([n,t]).toDate().valueOf(),a=moment(i).endOf("month").toDate().valueOf();return _.filter(this,function(t){return t._id>=i&&t._id<=a&&t._id!=e})}}();