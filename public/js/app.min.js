!function(){"use strict";function e(e,t){return t._id-e._id}function t(e,t){if(e){var n=$.map(e,function(e,n){return e._id==t?n:void 0});return n[0]}}angular.module("electricityUsageApp",["ui.router","infinite-scroll","hmTouchEvents","flash","ngAnimate","ngCookies","ngMessages"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/"),e.state("summary",{url:"/summary",templateUrl:"partials/summary.html",controller:"SummaryController",controllerAs:"summary"}).state("home",{url:"/",templateUrl:"partials/data.html",controller:"DataController",controllerAs:"data"}).state("settings",{url:"/settings",templateUrl:"partials/settings.html",controller:"MainController"})}]).run(["$rootScope","$state","$stateParams","$cookies","data",function(e,t,n,a,i){function r(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var s=a.get("guid");s||a.put("guid",r()),e.$state=t,e.$stateParams=n,e.$on("$stateChangeSuccess",function(t,n,a,i,r){e.$state.previous=i})}]).factory("Scopes",["$rootScope","$cookies",function(e,t){function n(e){return e+"-"+t.get("guid")}var a={};return{store:function(t,i){t=n(t),e.$broadcast("scope.stored",{key:t,value:i}),a[t]=i},get:function(e){return e=n(e),a[e]},remove:function(e){e=n(e),delete a[e]}}}]).filter("humanizeDuration",["$sce",function(e){return function(t){if(t=1e3*parseInt(t/1e3)){t=humanizeDuration(t,{largest:2,delimiter:","});var n=t.split(","),a=[];return angular.forEach(n,function(e){a.push('<span class="no-wrap">'+e+"</span>")}),e.trustAsHtml(a.join(" and "))}return null}}]).filter("dateFilter",function(){return function(e,t,n){if(!t&&!n)return e;var a=new Date(t)||new Date,i=new Date(n)||new Date,r=[];a=moment(a.getTime()).toDate().valueOf(),i=moment(i.getTime()).add(1,"days").toDate().valueOf();for(var s=0;s<e.length;s++){var o=parseInt(e[s]._id);o>=a?(!i||i&&i>=o)&&r.push(e[s]):i>=o&&(!a||a&&o>=a)&&r.push(e[s])}return r}}).filter("rangeFilter",function(){return function(e,t){if(!t)return e;var n=[],a=parseFloat(t.min||0),i=parseFloat(t.max)||(e.length?Math.max.apply(null,_.pluck(e,"reading")):!1);return angular.forEach(e,function(e){e.reading>=a&&(!i||e.reading<=i)&&n.push(e)}),n}}).filter("reverse",function(){return function(e){return e?e.slice().reverse():void 0}}).service("db",function(){var e="electricity-usage",t=new PouchDB(e,{auto_compaction:!0});return t}).factory("util",["$q","$rootScope",function(e,t){return{resolve:function(n){t.$apply(function(){return e.when(n)})},reject:function(n){t.$apply(function(){return e.reject(n)})}}}]).factory("data",["$rootScope","$cookies","db","util","dataService","Scopes",function(n,a,i,r,s,o){function c(){if($.isEmptyObject(h))return!1;var e,t="http://{0}:5984/{1}";e=String.format(t,h.server,h.database);var n={name:h.username,password:h.password},a={skipSetup:!0},i={ajax:{headers:{Authorization:"Basic "+window.btoa(n.name+":"+n.password)}}},r=new PouchDB(e,a);r.login(n.name,n.password,i,function(e,t){if(e){var n;switch(e.status){case 401:n=e.message;break;default:n=" Cannot connect to specified server or database. Please check your settings and try again."}return(h.enableSync||h.server&&h.database)&&o.store("flashMessage",{severity:"danger",title:String.format("Error {0}!",e.status),message:String.format("{0}<br>{1}",n,e.message)}),o.store("dbStatus",{dbConnection:!1}),!1}}).then(function(e){if(e){var t=[];angular.forEach(e.roles,function(e){return t.push(e.substring(1))}),o.store("userRoles",t)}h.enableSync?d():(o.store("flashMessage",{severity:"info",title:"Info: ",message:"You can now sync your data to the server."}),o.store("dbStatus",{dbConnection:!0}))})["catch"](function(e){})}function d(){console.log("sync");var e="http://{0}:{1}@{2}:5984/{3}",t=String.format(e,h.username,h.password,h.server,h.database);n.$apply(function(){m=i.sync(t,{live:!0,filter:function(e){return"reading"===e.type||e._deleted}}).on("paused",function(){v=!0,o.store("dbStatus",{dbConnection:v}),o.store("flashMessage",{title:"Success!",message:"Database sync successful.",severity:"success"}),console.log("paused")}).on("active",function(){console.log("active"),o.store("flashMessage",{title:"",message:"Syncing...",severity:"info"})}).on("denied",function(e){console.log("denied",e)}).on("complete",function(e){console.log(e)}).on("error",function(e){v=!1,o.store("dbStatus",{dbConnection:v}),console.log("error!",e)})})}function u(){return i.allDocs({include_docs:!0,descending:!0}).then(function(t){var i=t.rows.map(function(e){return e.doc});angular.forEach(i,function(e,t){switch(e.type){case"reading":p.push(e);break;case"settings":e._id=="settings-"+a.get("guid")&&($.extend(h,e),o.store("settings",h))}}),p.sort(e),n.$apply(),o.store("dataLoaded",!0),c()})}function l(){i.changes({live:!0,since:"now",include_docs:!0}).on("change",function(e){e.deleted?g(e.id):f(e.doc)}).on("error",console.log.bind(console))}function g(e){switch(e){case"settings-"+a.get("guid"):n.$apply(function(){h={}}),o.store("settings",h);break;default:var i=t(p,e),r=p[i];r&&r._id===e&&n.$apply(function(){p.splice(i,1)})}}function f(i){switch(i.type){case"reading":var r=t(p,i._id),s=p[r];n.$apply(function(){s&&s._id===i._id?p.splice(r,1,i):(p.splice(r,0,i),p.sort(e))});break;case"settings":"settings-"+a.get("guid")==i._id&&(n.$apply(function(){$.extend(h,i)}),o.store("settings",h),c());break;default:console.log(i.reading)}}var m,p=[],h={},v=!1;return u().then(l)["catch"](console.log.bind(console)),{dbConnection:v,docs:p,settings:h,syncDB:c,put:function(e,t){return t=void 0===t?!0:t,i.put(e,function(n){if(t)if(n){var a;switch(n.name){case"conflict":a="reading"==e.type?String.format('An entry with same date and time <span class="no-wrap"><b>({0})</b></span> already exists.',moment(parseInt(e._id)).format("MMM D, YYYY h:mm A")):"Entry already exists.";break;default:a="Entry already exists."}o.store("flashMessage",{title:"Error!",message:a,severity:"danger",pause:!0})}else{var i=o.get("dbStatus");if(void 0===i||!i.dbConnection){var r="";switch(e.type){case"settings":r="Settings saved successfully!";break;default:r="Entry saved successfully!"}o.store("flashMessage",{title:"Success!",message:r,severity:"success"})}}}).then(r.resolve)["catch"](r.reject)},get:function(e){return i.get(e).then(function(e){return e})["catch"](r.reject)},"delete":function(e,t){return t=void 0===t?!0:t,i.get(e._id).then(function(e){return i.remove(e).then(function(){if(t){var n="";switch(e.type){case"reading":n=String.format("Entry with reading of <b>{0}</b> dated <no-wrap><b>{1}</b></no-wrap> <no-wrap><b>{2}</b></no-wrap> was deleted successfully!",e.reading,moment(parseInt(e._id)).format("MMM D, YYYY"),moment(parseInt(e._id)).format("h:mm A"));break;default:n="Entry was deleted successfully!"}o.store("flashMessage",{title:"Success!",message:n,severity:"success"})}r.resolve()},r.reject)})["catch"](r.reject)}}}]).service("flashMessage",["Flash",function(e){return{create:function(t){e.dismiss(),e.create(t.severity,"<strong>"+t.title+"</strong>&nbsp;&nbsp;"+t.message,t["class"])},pause:function(){e.pause()}}}]).service("dataService",["Scopes","$cookies",function(e,t){function n(){a=e.get("settings"),i=a?a.electricityRate:13,i=i||13}var a,i;return{calculate:function(e){return n(),angular.forEach(e,function(t,n){var a=e[n+1];a?(t.duration=t._id-a._id,t.usage=t.reading-a.reading,t.cost=t.usage*i,t.aveUsagePerHour=t.usage/(t.duration/36e5),t.aveCostPerHour=t.aveUsagePerHour*i):(t.elapsedTime="-",t.usage="-",t.cost="-",t.aveUsagePerHour="-",t.aveCostPerHour="-")}),e},getSummary:function(e,t){if(e){var a={};n(),a.startDateTime=e._id,a.endDateTime=t._id,a.startReading=e.reading,a.latestReading=t.reading,a.electricityRate=i,a.currentUsage=t.reading-e.reading,a.elapsedTime=parseInt(t._id)-parseInt(e._id),a.currentCost=a.currentUsage*a.electricityRate;var r=a.elapsedTime/864e5;return a.aveUsagePerDay=r>=1?a.currentUsage/r:a.currentUsage,a.aveCostPerDay=r>=1?a.currentCost/r:a.currentCost,a}}}}]).controller("MainController",["$scope","$cookies","db","data","Scopes","flashMessage",function(e,t,n,a,i,r){function s(){e.settings.enableSync=!e.settings.enableSync,a.put(e.settings).then(function(t){a.get(u._id).then(function(t){e.$apply(function(){$.extend(a.settings,t),e.settings=a.settings}),e.settings.enableSync?i.store("flashMessage",{title:"",message:"Database sync started.",severity:"info"}):i.store("flashMessage",{title:"",message:"Stopping database sync...",severity:"info"})})},function(e){console.log(e)})}var o=3500;e.appName="reading-trackr",e.title=e.appName+" App",e.flashDuration=o,e.serverPlaceholder=window.location.hostname,e.defaultElectricityRate="Default: P 13.00";var c=(new Date).getFullYear(),d=2015!=c?"2015 - "+c:2015;e.footerText=String.format("Â© {0} Electricity Reading Trackr App | uNkNowN92",d),e.settings=a.settings,e.syncDB=function(){s()},e.$on("scope.stored",function(n,a){e.$apply(function(){switch(a.key){case"dbStatus-"+t.get("guid"):e.dbConnection=a.value.dbConnection,!e.dbConnection&&e.settings.enableSync&&s();break;case"flashMessage-"+t.get("guid"):r.create({severity:a.value.severity,title:a.value.title,message:a.value.message}),a.value.pause&&r.pause()}})});var u={_id:"settings-"+t.get("guid"),type:"settings"};e.saveSettings=function(){var t=u;$.extend(t,e.settings),a.put(t).then(function(t){a.get(u._id).then(function(t){e.$apply(function(){$.extend(a.settings,t),e.settings=a.settings}),i.store("flashMessage",{title:"Success!",message:"Settings saved successfully!",severity:"success"})})},function(e){console.log(e)})},e.resetSettings=function(){a.get(u._id).then(function(t){t.server=null,t.database=null,t.username=null,t.password=null,t.electricityRate=null,a.put(t).then(function(){e.$apply(function(){e.settings=a.settings,e.settingsForm.$setPristine()}),i.store("flashMessage",{title:"Success!",message:"Settings cleared successfully!",severity:"success"})})})["catch"](function(e){console.log(e)})}}]).controller("DataController",["$scope","data","dataService","Scopes","$filter",function(e,n,a,i,r){function s(t){e.editedReading[t]=null,e.editedDateTime[t]=null,delete e.editingId,o(),e.$apply()}function o(){$(".xdsoft_datetimepicker").fadeOut()}function c(e){return e=parseInt(e),e=r("date")(e,"mediumDate")+" "+r("date")(e,"shortTime"),new Date(e).getTime().toString()}e.docs=n.docs,e.focusReading=[],e.focusDateTime=[],e.editedReading=[],e.editedDateTime=[],e.editedStartOfMonth=[],e.limit=10,e.loadMore=function(){e.limit<e.docs.length&&(e.limit+=10)},e.beginEditing=function(n,a){var i=t(e.docs,n),s=e.docs[i];e.index=i,e.focusReading[i]="reading"==a,e.focusDateTime[i]="dateTime"==a,e.editingId=n,e.editedReading[i]=parseFloat(s.reading).toFixed(1),e.editedDateTime[i]=r("date")(s._id,"mediumDate")+" "+r("date")(s._id,"shortTime"),e.editedStartOfMonth[i]=s.startOfMonth?!0:"",$.datetimepicker.setLocale("en"),$("#"+n).datetimepicker({format:"M j, Y h:i A",step:15,value:new Date(parseInt(s._id))})},e.editReading=function(t){var a=e.index,i={_id:new Date(e.editedDateTime[a]).getTime().toString(),reading:parseFloat(e.editedReading[a]),startOfMonth:e.editedStartOfMonth[a]===!0};i._id=c(i._id),n.get(t).then(function(t){if(i._id!=t._id){n["delete"](t)["catch"](function(e){console.log(e)});var r={type:"reading"};$.extend(r,i),n.put(r).then(function(e){s(a)},function(e){console.log(e)})}else if(i.reading!=t.reading)$.extend(t,i),n.put(t).then(function(e){s(a)},function(e){console.log(e)});else if(i.startOfMonth!=t.startOfMonth){var o=e.docs.sameMonth(i._id),c=o.startOfMonth();angular.forEach(c,function(e){e.startOfMonth=!1,n.put(e,!1).then(function(e){},function(e){console.log(e)})}),$.extend(t,i),n.put(t).then(function(e){s(a)},function(e){console.log(e)})}else s(a)})},e.closeDateTimePicker=function(){o()},e.addNewDoc=function(){var t={type:"reading",_id:c(e.dateTime||(new Date).getTime().toString()),reading:parseFloat(e.newReading).toFixed(1),startOfMonth:e.startOfMonth||!1};n.put(t).then(function(t){e.$apply(function(){e.newReading=""})},function(e){console.log(e)})},e.deleteDoc=function(e){confirm("Are you sure you want to delete this entry?")&&n["delete"](e,!0)["catch"](function(e){console.log(e)})},e.windowWidth=window.innerWidth,$(window).resize(function(){e.$apply(function(){e.windowWidth=window.innerWidth})})}]).controller("SummaryController",["$scope","$cookies","data","Scopes","dataService","$filter",function(e,n,a,i,r,s){function o(){var t=_.map(e.docs.startOfMonth(),function(e){return{_id:e._id,reading:e.reading}}),n=[{value:"All",_id:0}];angular.forEach(t,function(e,a){var i=t[a-1];n.push({value:String.format("{0} ({1})",s("number")(e.reading,1),s("date")(e._id,"mediumDate")),_id:e._id,dateFrom:s("date")(e._id,"mediumDate"),dateTo:i?s("date")(i._id,"mediumDate"):"",startReading:e.reading,endReading:i?i.reading:""})}),e.startReadings=n,e.selectedStartReading=c(),d(),u()}function c(){var n=t(e.startReadings,e.settings.startReading);return e.startReadings?e.startReadings[n]||e.startReadings[0]:""}function d(){var t={};$.extend(t,l),a.get(l._id).then(function(n){$.extend(t,n),t.startReadings=e.startReadings,a.put(t,!0)})}function u(){e.readingRange.min=e.selectedStartReading.startReading||"",e.readingRange.max=e.selectedStartReading.endReading||"",e.dateFrom=e.selectedStartReading.dateFrom||"",e.dateTo=e.selectedStartReading.dateTo||""}e.docs=a.docs,e.limit=10,e.resetLimit=function(){e.limit=10},e.settings=a.settings,e.startReadings=a.settings.startReadings,e.selectedStartReading=c(),e.readingRange={};var l={_id:"settings-"+n.get("guid"),type:"settings"};o(),e.$on("scope.stored",function(t,a){e.$apply(function(){switch(a.key){case"dataLoaded-"+n.get("guid"):o()}})}),e.updateStartReading=function(){var t={};t.startReading=e.selectedStartReading._id,a.get(l._id).then(function(e){delete e.startReading,$.extend(t,e),a.put(t,!1).then(function(){u()})})},e.loadMore=function(t,n){n?e.limit=n:(e.limit<e.docs.length&&e.windowWidth>800||t)&&(e.limit+=10)},e.downloadResultJson=function(){},e.getSummary=function(){var t,n,a;if(e.dateFrom||e.dateTo||e.readingRange){if($.isEmptyObject(e.filteredDates))return;n=e.readingRange.min?e.filteredDates.getIndexByReading(e.readingRange.min):e.filteredDates[0],t=e.dateTo&&!e.readingRange.max?e.filteredDates[e.filteredDates.length-1]:e.readingRange.max?e.docs.getIndexByReading(e.readingRange.max):e.docs[0],a=r.getSummary(n,t)}else{if($.isEmptyObject(e.docs))return;n=e.docs[e.docs.length-1],t=e.docs[0],a=r.getSummary(n,t)}$.extend(e,a),e.docs=r.calculate(e.docs)},e.windowWidth=window.innerWidth,$(window).resize(function(){e.$apply(function(){e.windowWidth=window.innerWidth})})}]).directive("datetimePicker",["$timeout",function(e){return{restrict:"A",link:function(e,t,n){var a={value:new Date},i={};switch(n.datetimePicker){case"date":i.timepicker=!1,i.datepicker=!0,i.format="M j, Y";break;case"time":i.timepicker=!0,i.datepicker=!1,i.format="h:i A",i.step=15;break;default:i.format="M j, Y h:i A",i.step=15}$.extend(a,i),$('[datetime-picker="'+n.datetimePicker+'"]').datetimepicker(a)}}}]).directive("navbar",function(){return{restrict:"E",templateUrl:"partials/navbar.html",controller:"MainController"}}).directive("copyright",function(){return{restrict:"E",templateUrl:"partials/copyright.html",controller:"MainController"}}).directive("notification",["$timeout",function(e){return{restrict:"E",template:"<div class='alert alert-{{alertData.type}}' ng-show='alertData.message' role='alert' data-notification='{{alertData.status}}'>{{alertData.message}}</div>",scope:{alertData:"="}}}]).directive("validateFloat",function(){var e=/^\-?\d+((\.|\,)\d{0,1})?$/;return{require:"ngModel",link:function(t,n,a,i){i.$parsers.unshift(function(t){return""===t?(i.$setValidity("float",!0),t):e.test(t)?(i.$setValidity("float",!0),parseFloat(t.replace(",","."))):void i.$setValidity("float",!1)})}}}).directive("autoFocus",["$timeout",function(e){return{restrict:"AC",link:function(t,n){e(function(){n[0].focus()},0)}}}]).directive("focus",["$timeout",function(e){return{scope:{trigger:"=focus"},link:function(t,n){t.$watch("trigger",function(t){t===!0&&e(function(){n[0].focus()},250)})}}}]).directive("onShow",function(){});String.format=function(){for(var e=arguments[0],t=0;t<arguments.length-1;t++){var n=new RegExp("\\{"+t+"\\}","gm");e=e.replace(n,arguments[t+1])}return e},Array.prototype.getIndexByReading=function(e){return _.map(_.where(this,{reading:e}))[0]},Array.prototype.startOfMonth=function(){return _.map(_.where(this,{startOfMonth:!0}))},Array.prototype.sameMonth=function(e){var t=moment(parseInt(e)).get("month"),n=moment(parseInt(e)).get("year"),a=moment([n,t]).toDate().valueOf(),i=moment(a).endOf("month").toDate().valueOf();return _.filter(this,function(t){return t._id>=a&&t._id<=i&&t._id!=e})}}();